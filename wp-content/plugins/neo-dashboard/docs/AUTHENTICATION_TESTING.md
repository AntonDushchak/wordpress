# Neo Dashboard - Руководство по тестированию системы аутентификации

## Обзор

Система аутентификации Neo Dashboard обеспечивает многоуровневую защиту с ролевым доступом для пользователей.

## Компоненты системы

### 1. AccessControl.php
- **Назначение**: Основной класс для управления доступом
- **Функции**:
  - Проверка аутентификации пользователей
  - Управление ролевым доступом
  - Редиректы на страницы входа/dashboard
  - Ограничение доступа к админ-панели

### 2. SecurityEnforcer.php
- **Назначение**: Дополнительные меры безопасности
- **Функции**:
  - Блокировка прямого доступа к файлам
  - Защита через .htaccess
  - Логирование попыток несанкционированного доступа
  - Блокировка запрещенных URL

### 3. Шаблоны
- `access-denied.php` - Страница отказа в доступе
- `auth-test.php` - Страница для тестирования аутентификации

## Роли пользователей

### Neo Editor (`neo_editor`)
- **Доступ**: Только к страницам с префиксом `/neo-dashboard`
- **Ограничения**: Нет доступа к стандартной админ-панели WordPress
- **Возможности**: Редактирование контента в Neo Dashboard

### Neo Mitarbeiter (`neo_mitarbeiter`)
- **Доступ**: Только к страницам с префиксом `/neo-dashboard`
- **Ограничения**: Нет доступа к стандартной админ-панели WordPress
- **Возможности**: Работа с Neo Dashboard в рамках своей роли

### Administrator (`administrator`)
- **Доступ**: Полный доступ ко всем страницам
- **Ограничения**: Отсутствуют
- **Возможности**: Полное управление сайтом и Neo Dashboard

## Тестирование системы

### Шаг 1: Создание тестовых пользователей

```php
// Создать пользователя с ролью Neo Editor
$user_id = wp_create_user('neo_editor_test', 'password123', 'editor@example.com');
$user = new WP_User($user_id);
$user->set_role('neo_editor');

// Создать пользователя с ролью Neo Mitarbeiter
$user_id = wp_create_user('neo_mitarbeiter_test', 'password123', 'mitarbeiter@example.com');
$user = new WP_User($user_id);
$user->set_role('neo_mitarbeiter');
```

### Шаг 2: Использование шорткода для тестирования

Добавьте шорткод `[neo_auth_test]` на любую страницу WordPress для проверки текущего статуса аутентификации.

### Шаг 3: Тестовые сценарии

#### Сценарий 1: Неавторизованный пользователь
1. Выйдите из системы
2. Попробуйте перейти на `/neo-dashboard`
3. **Ожидаемый результат**: Редирект на `wp-login.php`

#### Сценарий 2: Пользователь Neo Editor
1. Войдите как `neo_editor_test`
2. Попробуйте перейти на `/wp-admin`
3. **Ожидаемый результат**: Редирект на `/neo-dashboard`
4. Перейдите на `/neo-dashboard`
5. **Ожидаемый результат**: Доступ разрешен

#### Сценарий 3: Пользователь Neo Mitarbeiter
1. Войдите как `neo_mitarbeiter_test`
2. Попробуйте перейти на `/wp-admin`
3. **Ожидаемый результат**: Редирект на `/neo-dashboard`
4. Перейдите на `/neo-dashboard`
5. **Ожидаемый результат**: Доступ разрешен

#### Сценарий 4: Администратор
1. Войдите как администратор
2. Перейдите на `/wp-admin`
3. **Ожидаемый результат**: Доступ разрешен
4. Перейдите на `/neo-dashboard`
5. **Ожидаемый результат**: Доступ разрешен

### Шаг 4: Проверка безопасности

#### Проверка .htaccess защиты
1. Попробуйте прямой доступ к файлам плагина:
   - `yoursite.com/wp-content/plugins/neo-dashboard/src/AccessControl.php`
   - **Ожидаемый результат**: 403 Forbidden

#### Проверка блокировки файлов
1. Попробуйте доступ к защищенным файлам:
   - `yoursite.com/wp-config.php`
   - `yoursite.com/readme.html`
   - **Ожидаемый результат**: 403 Forbidden

## Отладка

### Включение режима отладки

В `wp-config.php`:
```php
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
define('WP_DEBUG_DISPLAY', true);
```

### Проверка логов

Логи аутентификации сохраняются в:
- `/wp-content/debug.log` - основные логи WordPress
- `/wp-content/plugins/neo-dashboard/logs/` - логи Neo Dashboard (если настроено)

### Полезные функции для отладки

```php
// Проверить текущую роль пользователя
$current_role = get_current_neo_role();

// Проверить доступ к Neo Dashboard
$has_access = can_access_neo_dashboard();

// Получить информацию о пользователе
$user_info = AccessControl::getCurrentUserInfo();
```

## Устранение неполадок

### Проблема: Бесконечные редиректы
**Решение**: Проверьте, что URL `/neo-dashboard` корректно обрабатывается роутером

### Проблема: Пользователи не могут войти
**Решение**: 
1. Проверьте, что роли созданы
2. Убедитесь, что пользователям назначены правильные роли
3. Проверьте логи на ошибки

### Проблема: .htaccess не работает
**Решение**:
1. Убедитесь, что Apache поддерживает .htaccess
2. Проверьте права на запись в директорию плагина
3. Убедитесь, что mod_rewrite включен

## Дополнительная настройка

### Изменение URL редиректа после входа

В `AccessControl.php` измените:
```php
public static function loginRedirect(): string
{
    return home_url('/your-custom-dashboard');
}
```

### Добавление новых защищенных ролей

В `AccessControl.php` добавьте в метод `hasNeoRole()`:
```php
$neo_roles = ['neo_editor', 'neo_mitarbeiter', 'your_new_role'];
```

### Настройка дополнительных ограничений URL

В `SecurityEnforcer.php` добавьте в `blockRestrictedUrls()`:
```php
$restricted_patterns = [
    '/wp-admin/',
    '/wp-login.php',
    '/your-restricted-path/'
];
```